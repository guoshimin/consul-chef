#!/bin/bash

docker run -d \
  --net host \
  --name consul \
  --restart=always \
  --log-driver=journald \
  -v /apps/consul/data:/consul/data \
  -v /apps/consul/config:/consul/config \
  -e CONSUL_GID=<%= node['consul']['gid'] %> \
  -e CONSUL_UID=<%= node['consul']['uid'] %> \
  registry.dev.databricks.com/shimin/consul:201510020941 \
  /runonce.sh exec sudo -u consul /databricks/consul/consul \
  agent \
  -bootstrap-expect=3 \
  -node=<%= node['name'] %> \
  -config-file=/consul/config/server.json "$@"
